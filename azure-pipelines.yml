trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: Release

steps:
  - task: DotNetCoreCLI@2
    displayName: Restore .NET Tools
    inputs:
      command: custom
      custom: tool
      arguments: restore

  - task: DotNetCoreCLI@2
    displayName: Run Cake Build Script
    inputs:
      command: custom
      custom: cake
      arguments: --Configuration=$(buildConfiguration)

  - task: PublishTestResults@2
    displayName: Publish Test Results
    inputs:
      failTaskOnFailedTests: true
      mergeTestResults: false
      testResultsFiles: $(Build.SourcesDirectory)/Tests/**/TestResults/*.trx
      testResultsFormat: VSTest

  - task: PublishCodeCoverageResults@1
    displayName: Publish Code Coverage Results
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(Build.SourcesDirectory)/Artifacts/Test/CoverageReports/Combined/Cobertura.xml'
      reportDirectory: '$(Build.SourcesDirectory)/Artifacts/Test/CoverageReports/Combined'
      failIfCoverageEmpty: true

  - task: PublishBuildArtifacts@1
    displayName: Publish Release Artifact
    inputs:
      artifactName: Release
      pathToPublish: $(Build.SourcesDirectory)/Artifacts/Build/Release
      publishLocation: Container
