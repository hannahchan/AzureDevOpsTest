pool:
  vmImage: ubuntu-latest

jobs:
  - job: build
    displayName: Build
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    steps:
      - task: DotNetCoreCLI@2
        displayName: Restore .NET Tools
        inputs:
          command: custom
          custom: tool
          arguments: restore

      - task: DotNetCoreCLI@2
        displayName: Run Cake Build Script
        inputs:
          command: custom
          custom: cake
          arguments: --Target=Publish

      - task: PublishTestResults@2
        displayName: Publish Test Results
        inputs:
          failTaskOnFailedTests: true
          mergeTestResults: true
          testResultsFiles: $(Build.SourcesDirectory)/Tests/**/TestResults/*.trx
          testResultsFormat: VSTest
          testRunTitle: Integration and Unit Tests

      - task: PublishCodeCoverageResults@1
        displayName: Publish Code Coverage Results
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: $(Build.SourcesDirectory)/Artifacts/Test/CoverageReports/Combined/Cobertura.xml
          failIfCoverageEmpty: true

      - task: PublishBuildArtifacts@1
        displayName: Publish Release Artifacts
        inputs:
          artifactName: Artifacts
          pathToPublish: $(Build.SourcesDirectory)/Artifacts
          publishLocation: Container
