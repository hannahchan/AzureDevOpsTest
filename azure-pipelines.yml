trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: Release

steps:
  - task: DotNetCoreCLI@2
    displayName: "Restore .NET Tools"
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'restore'

  - task: DotNetCoreCLI@2
    displayName: "Run Cake Build Script"
    inputs:
      command: 'custom'
      custom: 'cake'
      arguments: '--Configuration=$(buildConfiguration)'

  - task: PublishTestResults@2
    displayName: "Publish Test Results"
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '$(Build.SourcesDirectory)/Tests/**/TestResults/*.trx'
      mergeTestResults: false
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@1
    displayName: "Publish Code Coverage Results"
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(Build.SourcesDirectory)/Tests/**/TestResults/*/coverage.cobertura.xml'
      failIfCoverageEmpty: true

  - task: PublishBuildArtifacts@1
    displayName: "Publish Release Artifact"
    inputs:
      artifactName: Release
      pathToPublish: $(Build.SourcesDirectory)/Artifacts/Build/Release
      publishLocation: Container
