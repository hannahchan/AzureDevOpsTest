trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: Release

jobs:
  - job: build
    displayName: Build
    steps:
      - task: DotNetCoreCLI@2
        displayName: Restore .NET Tools
        inputs:
          command: custom
          custom: tool
          arguments: restore

      - task: DotNetCoreCLI@2
        displayName: Run Cake Build Script
        inputs:
          command: custom
          custom: cake
          arguments: --Configuration=$(buildConfiguration) --Target=Containerize

      - task: PublishTestResults@2
        displayName: Publish Test Results
        inputs:
          failTaskOnFailedTests: true
          mergeTestResults: true
          testResultsFiles: $(Build.SourcesDirectory)/Tests/**/TestResults/*.trx
          testResultsFormat: VSTest
          testRunTitle: Integration and Unit Tests

      - task: PublishCodeCoverageResults@1
        displayName: Publish Code Coverage Results
        inputs:
          codeCoverageTool: "Cobertura"
          summaryFileLocation: "$(Build.SourcesDirectory)/Artifacts/Test/CoverageReports/Combined/Cobertura.xml"
          failIfCoverageEmpty: true

      - task: PublishBuildArtifacts@1
        displayName: Publish Release Artifact
        inputs:
          artifactName: Release
          pathToPublish: $(Build.SourcesDirectory)/Artifacts/Build/Scaffold.WebApi.zip
          publishLocation: Container
